# Monitoring Service API

This document describes the monitoring endpoints implemented in the backend, aligned with the Spring architecture used by the notification service.

Base path: `/api/monitoring`

## Measurements

- POST `/api/monitoring/measurements`
  - Ingest a new measurement for a patient. Performs simple threshold evaluation and may open a monitoring event and send an in-app notification for ALERT/CRITICAL severities.
  - Body (JSON):
    - `patientId` (string, required)
    - `type` (enum, required): `HEART_RATE`, `SPO2`, `STEPS`, `BLOOD_PRESSURE`, `GLUCOSE`, `WEIGHT`
    - `value` (number, required): main value. For `BLOOD_PRESSURE`, this is systolic.
    - `value2` (number, optional): used for diastolic when `type=BLOOD_PRESSURE`.
    - `unit` (string, optional): e.g., `bpm`, `%`, `mmHg`, `mg/dL`, `kg`.
    - `measuredAt` (ISO-8601, optional): UTC instant; defaults to now if omitted.
  - Response 201 (JSON):
    - `id` (UUID)
    - `patientId` (string)
    - `type` (enum)
    - `value` (number)
    - `value2` (number|null)
    - `unit` (string|null)
    - `measuredAt` (ISO-8601)
    - `createdAt` (ISO-8601)
    - `eventId` (UUID|null): present if an event was opened
    - `eventSeverity` (enum|null): `INFO|WARNING|ALERT|CRITICAL` when event created
    - `eventMessage` (string|null)

Example request:

```
POST /api/monitoring/measurements
{
  "patientId": "patient-123",
  "type": "BLOOD_PRESSURE",
  "value": 168,
  "value2": 102,
  "unit": "mmHg",
  "measuredAt": "2025-01-01T10:15:00Z"
}
```

Example response (event created):

```
201 Created
{
  "id": "...",
  "patientId": "patient-123",
  "type": "BLOOD_PRESSURE",
  "value": 168,
  "value2": 102,
  "unit": "mmHg",
  "measuredAt": "2025-01-01T10:15:00Z",
  "createdAt": "2025-01-01T10:15:01Z",
  "eventId": "...",
  "eventSeverity": "ALERT",
  "eventMessage": "BP out-of-range: 168/102 mmHg"
}
```

## Events

- GET `/api/monitoring/events`
  - List monitoring events for a patient, newest first.
  - Query params:
    - `patientId` (string, required)
    - `status` (enum, optional): `OPEN|ACKNOWLEDGED|RESOLVED`
    - `page` (int, default 0)
    - `size` (int, default 20, max 100)
  - Response 200: array of events
    - Fields: `id`, `patientId`, `type`, `status`, `severity`, `message`, `measurementId`, `createdAt`, `resolvedAt`

- PATCH `/api/monitoring/events/{id}/ack`
  - Mark event as `ACKNOWLEDGED`.
  - Response 204

- PATCH `/api/monitoring/events/{id}/resolve`
  - Mark event as `RESOLVED` and set `resolvedAt`.
  - Response 204

## Metrics

- GET `/api/monitoring/metrics/latest`
  - Return the latest measurement per type for a patient.
  - Query params:
    - `patientId` (string, required)
  - Response 200: array of measurement objects (same shape as ingest response without event fields), one per available type.

## Thresholds & Notifications

- Current thresholds are simple defaults embedded in the service:
  - HEART_RATE: ALERT if `<50` or `>110`, CRITICAL if `<40` or `>130`.
  - SPO2: ALERT if `<92%`, CRITICAL if `<88%`.
  - BLOOD_PRESSURE: ALERT if `sys>=160` or `dia>=100` or `sys<90` or `dia<55`; CRITICAL if `sys>=180` or `dia>=110` or `sys<85` or `dia<50`.
  - GLUCOSE: ALERT if `<70` or `>180 mg/dL`, CRITICAL if `<60` or `>250 mg/dL`.
  - WEIGHT/STEPS: no events generated by default.

- When severity is `ALERT` or `CRITICAL`, an in-app notification is sent to the patient using the existing notification service (channel: `IN_APP`).

## Notes

- Entities: `Measurement`, `MonitoringEvent` with repositories and service encapsulating logic.
- DTOs and controllers follow the same conventions as `notification` package (validation, pagination caps, enums as strings).
- Thresholds can be externalized in `application.yml` later if needed.

