# Telegraf Configuration for eSant√© Stream Processing
# Reads patient vitals from MQTT, checks for alerts, and routes to notifications or InfluxDB

[agent]
  interval = "1s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "1s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = ""
  omit_hostname = false

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# Subscribe to MQTT topics for patient vitals
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "esante/patient/+/vitals/#"
  ]
  qos = 1
  connection_timeout = "30s"
  client_id = "telegraf_esante_consumer"
  
  # Parse JSON payload
  data_format = "json"
  json_name_key = "vitalType"
  json_string_fields = ["patientId", "deviceId", "vitalType"]
  json_time_key = "timestamp"
  json_time_format = "2006-01-02T15:04:05Z07:00"
  
  # Extract patientId from topic path
  topic_tag = "mqtt_topic"

###############################################################################
#                          PROCESSOR PLUGINS                                  #
###############################################################################

# Extract patientId from topic (esante/patient/{id}/vitals/{type})
[[processors.regex]]
  [[processors.regex.tags]]
    key = "mqtt_topic"
    pattern = "^esante/patient/([^/]+)/vitals/(.+)$"
    replacement = "${1}"
    result_key = "patientId"

  [[processors.regex.tags]]
    key = "mqtt_topic"
    pattern = "^esante/patient/([^/]+)/vitals/(.+)$"
    replacement = "${2}"
    result_key = "measurementType"

# Check for alert conditions and tag accordingly
[[processors.starlark]]
  source = '''
def apply(metric):
    # Get values from metric (Telegraf flattens nested JSON)
    battery = metric.fields.get("metadata_battery", 100.0)
    value = metric.fields.get("value", 0.0)
    measurement_type = metric.tags.get("measurementType", "")
    
    # Determine if this is an alert
    is_alert = False
    alert_reason = ""
    
    # Check battery level
    if battery < 30:
        is_alert = True
        alert_reason = "Low battery: " + str(int(battery)) + "%"
    
    # Check heart rate (only for HEART_RATE measurements)
    if measurement_type == "HEART_RATE" and value > 150:
        is_alert = True
        if alert_reason:
            alert_reason += "; High heart rate: " + str(int(value)) + " BPM"
        else:
            alert_reason = "High heart rate: " + str(int(value)) + " BPM"
    
    # Add alert tags
    if is_alert:
        metric.tags["alert"] = "true"
        metric.fields["alertReason"] = alert_reason
    else:
        metric.tags["alert"] = "false"
    
    return metric
'''

###############################################################################
#                           OUTPUT PLUGINS                                    #
###############################################################################

# Output 1: Send ALERTS to MQTT notifications topic
[[outputs.mqtt]]
  servers = ["tcp://mosquitto:1883"]
  topic = "esante/notifications/patient/{{ .Tag \"patientId\" }}"
  qos = 1
  client_id = "telegraf_esante_notifications"
  
  # Only send metrics tagged as alerts
  tagpass = { alert = ["true"] }
  
  # Format as JSON
  data_format = "json"
  json_timestamp_units = "1ms"

# Output 2: Write NON-ALERTS to InfluxDB
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "esante-admin-token-change-in-production"
  organization = "esante"
  bucket = "patient_vitals"
  
  # Only send metrics NOT tagged as alerts
  tagdrop = { alert = ["true"] }
  
  # Remove mqtt_topic tag before writing
  tagexclude = ["mqtt_topic", "host", "alert"]
  
  # Use vitalType as measurement name if available
  name_override = "vitals"

# Output 3: Debug output (optional, for troubleshooting)
[[outputs.file]]
  files = ["stdout"]
  data_format = "influx"
