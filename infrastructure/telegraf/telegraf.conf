# Telegraf Configuration for eSant√© Stream Processing
# Reads patient vitals from MQTT, checks for alerts, and routes to notifications or InfluxDB

[agent]
  interval = "1s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "1s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = ""
  omit_hostname = false

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# Subscribe to MQTT topics for patient vitals
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "esante/patient/+/vitals/#"
  ]
  qos = 1
  connection_timeout = "30s"
  client_id = "telegraf_esante_consumer"
  
  # Parse JSON payload from simulator
  data_format = "json"
  # Simulator uses measurementType; keep name override logic in processor
  json_name_key = "measurementType"
  # Flattened fields appear as metadata_*; keep numbers as numbers
  json_time_key = "timestamp"
  json_time_format = "2006-01-02T15:04:05Z07:00"
  
  # Extract patientId from topic path
  topic_tag = "mqtt_topic"

###############################################################################
#                          PROCESSOR PLUGINS                                  #
###############################################################################

# Extract patient and measurementType from topic (esante/patient/{id}/vitals/{type})
[[processors.regex]]
  [[processors.regex.tags]]
    key = "mqtt_topic"
    pattern = "^esante/patient/([^/]+)/vitals/(.+)$"
    replacement = "${1}"
    result_key = "patient"

  [[processors.regex.tags]]
    key = "mqtt_topic"
    pattern = "^esante/patient/([^/]+)/vitals/(.+)$"
    replacement = "${2}"
    result_key = "measurementType"

# Normalize measurements, map fields, and tag alerts
[[processors.starlark]]
  source = '''
def apply(metric):
    # Map MQTT topic extracted tags
    patient = metric.tags.get("patient", "")
    mtype = metric.tags.get("measurementType", "")
    val = metric.fields.get("value")
    val2 = metric.fields.get("value2")
    battery = metric.fields.get("metadata_battery", 100.0)

    # Default: no alert
    is_alert = False
    reason = ""

    # Alert rules (align with simulator + project needs)
    if battery != None and battery < 30:
        is_alert = True
        reason = "Low battery: " + str(int(battery)) + "%"
    if mtype == "HEART_RATE" and val != None and val > 150:
        is_alert = True
        if reason:
            reason += "; High heart rate: " + str(int(val)) + " BPM"
        else:
            reason = "High heart rate: " + str(int(val)) + " BPM"

    # Map measurement name and fields to reporting-service schema
    # fc (heart rate), spO2, tension(systolique/diastolique), glycemie, poids
    if mtype == "HEART_RATE":
        metric.name = "fc"
        # keep field 'value'
    elif mtype == "SPO2":
        metric.name = "spO2"
    elif mtype == "BLOOD_PRESSURE":
        metric.name = "tension"
        # map value -> systolique, value2 -> diastolique
        if val != None:
            metric.fields["systolique"] = val
        if val2 != None:
            metric.fields["diastolique"] = val2
        # drop original fields
        if "value" in metric.fields:
            metric.fields.pop("value", None)
        if "value2" in metric.fields:
            metric.fields.pop("value2", None)
    elif mtype == "GLUCOSE":
        metric.name = "glycemie"
    elif mtype == "WEIGHT":
        metric.name = "poids"
    else:
        # Keep other types as-is (e.g., STEPS)
        pass

    # Set 'patient' tag as numeric id from topic
    if patient:
        metric.tags["patient"] = patient

    # Mark alert tag/field
    if is_alert:
        metric.tags["alert"] = "true"
        metric.fields["alertReason"] = reason
    else:
        metric.tags["alert"] = "false"

    return metric
'''

###############################################################################
#                           OUTPUT PLUGINS                                    #
###############################################################################

# Output 1: Send ALERTS to MQTT notifications topic
[[outputs.mqtt]]
  servers = ["tcp://mosquitto:1883"]
  topic = "esante/notifications/patient/{{ .Tag \"patient\" }}"
  qos = 1
  client_id = "telegraf_esante_notifications"
  
  # Only send metrics tagged as alerts
  tagpass = { alert = ["true"] }
  
  # Format as JSON
  data_format = "json"
  json_timestamp_units = "1ms"

# Output 2: Write NON-ALERTS to InfluxDB
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "my-super-secret-auth-token"
  organization = "eSanteIdb"
  bucket = "mesure_data"
  
  # Only send metrics NOT tagged as alerts
  tagdrop = { alert = ["true"] }
  
  # Remove internal tags before writing
  tagexclude = ["mqtt_topic", "host", "measurementType"]

# Output 3: Debug output (optional, for troubleshooting)
[[outputs.file]]
  files = ["stdout"]
  data_format = "influx"
